---
title: "Epidemia Covid-19 na Ukrainie"

date: 
output:
  html_document: default
---

data wygenerowania raportu: `r format(Sys.time(),"%d %B %Y, %H:%M")`


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
```{r include=FALSE, message=FALSE}
library(maptools)
library(rgeos)
library(rgdal)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(ggthemes)
library(scales)
library(tidyr)
library(dplyr)
```
```{r message=FALSE, include=FALSE}
shp1 <- readOGR("E:/R/UA_spis/data/mapa", layer = "obwod_pl")
#zmieniamy format danych
shp1f <- fortify(shp1, region = "ADM1_PCODE")


# dzienne dane z obwodów i szpitali
load(file = "E:/R/COVID-19/Ukraina.dane/obwody.lista.Rda")
obwody.lista <- obwody %>%
  # trzeba poprawic współrzędne Kijowa, bo nie widać go na mapie
  select(1:3,7)
obwody.lista[13,1] <- 50.777435
obwody.lista[13,2] <- 30.167475
rm(obwody)

load(file = "E:/R/COVID-19/Ukraina.dane/obwody_dzienne.Rda")
obwody <- obwody %>%
  select(-c(7,8))%>%
  left_join(obwody.lista, by="Kod")%>%
  mutate(lat = as.numeric(lat), long = as.numeric(long))

load(file = "E:/R/COVID-19/Ukraina.dane/szpitale.lozka.Rda")
szpitale.lozka <- szpitale.lozka %>% 
  select(-c(6,7))%>%
  left_join(obwody.lista, by="Kod")%>%
  mutate(lat = as.numeric(lat), long = as.numeric(long))

load(file = "E:/R/COVID-19/Ukraina.dane/szpitale.oblozenie.Rda")
szpitale.oblozenie <- szpitale.oblozenie %>%
  select(-c(3,4))%>%
  left_join(obwody.lista, by="Kod")%>%
  mutate(lat = as.numeric(lat), long = as.numeric(long))

```


```{r}
a <- obwody %>%
  filter(data== max(data)) %>%
  group_by(Obwód, Kod, data)%>%
  summarise(
    liczba = sum(liczba),
    data2 = max(data)+1
  ) 

d <- a %>%
  arrange(desc(liczba))

b <- obwody %>%
  filter(data== max(data))%>%
  filter(skumulowane=="zgony")
c <- obwody %>%
  filter(data== max(data))%>%
  filter(skumulowane=="wyleczeni")
```


***


### Sytuacja w regionach Ukrainy

Wedug danych Ministerstwa Zdrowia  z `r unique(format(a$data2, "%d"))` `r if_else(unique(format(a$data2, "%B"))=="marzec", paste("marca"), paste("kwietnia"))` `r unique(format(a$data2, "%Y"))` z godziny 9.00 od początku epidemii na Ukrainie zanotowano w sumie `r sum(a$liczba)` przypadków zarażenia Covid-19, z czego `r sum(b$liczba)` osób zmarło i `r sum(c$liczba)` się wyleczyło.  
Najwięcej zarażeń jest `r if_else(d[1,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", d[1,1], "m"))` (`r d[1,4]`) oraz `r if_else(d[2,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", d[2,1], "m"))` (`r d[2,4]`) i `r if_else(d[3,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", d[3,1], "m"))` (`r d[3,4]`). 

```{r}
ggplot() + 
  geom_map(data=a, aes(map_id=Kod, fill=liczba), map=shp1f) + 
  geom_path(data = shp1f, aes(x=long, y=lat, group=group), colour="grey", size=0.001) + 
  coord_map(projection = "mercator") + 
  scale_fill_gradient(low = "white", high = "orange") +
  labs(fill= "liczba \nzarażeń", title = "Liczba potwierdzonych przypadków Covid-19",
       subtitle =  paste0( "stan na ", format(as.Date(a$data2), "%d/%m/%Y"), ", godz. 9.00"),
       caption = "Źródło - Ministerstwo Zdrowia Ukrainy") +
  geom_label(data=szpitale.lozka, aes(x=long, y=lat), label=a$liczba, size=3) +
  theme_bw()+
  theme(axis.ticks = element_blank(), panel.border = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = c(0.1, 0.2),
        panel.grid.minor = element_blank(),panel.grid.major = element_blank(), plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5), plot.background = element_rect(colour = "grey", size = 0.5), 
        plot.caption = element_text(size = 8))

```


***


```{r}
a <- obwody %>%
  filter(data== max(data)) %>%
  group_by(Obwód, Kod, data)%>%
  summarise(
    ilosc = sum(ilosc),
    data2 = max(data)+1
  )
suma <- sum(a$ilosc)

b <- arrange(a,  desc(ilosc))

# oliczamy procentowy przyrost zachorowań dla całego kraju
c <- obwody %>%
  group_by(data)%>%
  summarise(
    liczba = sum(liczba)
  ) %>%
  mutate(przyrost.proc = ((liczba/lag(liczba, default = first(liczba)))-1)*100)%>%
  filter(data==max(data))%>%
  mutate(przyrost.proc= round(przyrost.proc, 1))

#mutate(proc.wzrostu.chorych = (suma.chorych/lag(suma.chorych, default = first(suma.chorych)))-1)
```

W ciągu minionej doby zarejestrowano `r suma` nowych przypadków, co oznacza wzrost zarażeń o `r paste0(c[,3], "%")`. Najwięcej `r if_else(b[1,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", b[1,1], "m"))` (`r b[1,4]`), `r if_else(b[2,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", b[2,1], "m"))` (`r b[2,4]`) oraz `r if_else(b[3,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", b[3,1], "m"))` (`r b[3,4]`). Ogółem nowe zarażenia zanotowano w `r sum(b$ilosc>0)` obwodach, a w `r sum(b$ilosc==0)` nie stwierdzono nowych przypadków. 

```{r}

ggplot() + 
  geom_map(data=a, aes(map_id=Kod, fill=ilosc), map=shp1f) + 
  geom_path(data = shp1f, aes(x=long, y=lat, group=group), colour="grey", size=0.001) + 
  coord_map(projection = "mercator") + 
  scale_fill_gradient(low = "white", high = "orange") +
  labs(fill= "liczba nowych\nprzypadków", title = "Liczba nowych przypadków Covid-19 w ciągu ostatniej doby",
       subtitle =  paste0( "stan na ", format(as.Date(a$data2), "%d/%m/%Y"), ", godz. 9.00"),
       caption = "Źródło - Ministerstwo Zdrowia Ukrainy") +
  geom_label(data=szpitale.lozka, aes(x=long, y=lat), label=a$ilosc, size=3) +
  theme_bw()+
  theme(axis.ticks = element_blank(), panel.border = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = c(0.1, 0.2),
        panel.grid.minor = element_blank(),panel.grid.major = element_blank(), plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5), plot.background = element_rect(colour = "grey", size = 0.5), 
        plot.caption = element_text(size = 8))

```


***
```{r}
a <- obwody %>%
  filter(data== max(data)) %>%
  group_by(Obwód, Kod, data, population)%>%
  summarise(
    liczba = sum(liczba),
    data2 = max(data)+1
  ) %>%
  mutate(zach.100 = liczba*100000/population)%>%
  mutate(zach.100 = round(zach.100, 2))
b <- a %>%
  arrange(desc(zach.100))

```

Pod względem ilości przypadków na 100 tysięcy mieszkańców, najwyższy poziom zarażeń jest `r if_else(b[1,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", b[1,1], "m"))` (`r b[1,7]`) oraz `r if_else(b[2,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", b[2,1], "m"))` (`r b[2,7]`) i `r if_else(b[3,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", b[3,1], "m"))` (`r b[3,7]`). W `r sum(b$zach.100<1)` obwodach poziom zarażeń nie przekracza 1 osoby na 100 tys. 

```{r}
ggplot() + 
  geom_map(data=a, aes(map_id=Kod, fill=zach.100), map=shp1f) + 
  geom_path(data = shp1f, aes(x=long, y=lat, group=group), colour="grey", size=0.001) + 
  coord_map(projection = "mercator") + 
  scale_fill_gradient(low = "white", high = "orange") +
  labs(fill= "liczba\nzarażonych", 
       title = "Liczba zarażonych Covid-19 na 100 tys. mieszkańców",
       subtitle =  paste0( "stan na ", format(as.Date(a$data2), "%d/%m/%Y"), ", godz. 9.00"),
       caption = "Źródło - Ministerstwo Zdrowia Ukrainy, liczba ludności wg tzw. spisu Dubileta") +
  geom_label(data=szpitale.lozka, aes(x=long, y=lat), label=a$zach.100, size=3) +
  theme_bw()+
  theme(axis.ticks = element_blank(), panel.border = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = c(0.1, 0.2),
        panel.grid.minor = element_blank(),panel.grid.major = element_blank(), plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5), plot.background = element_rect(colour = "grey", size = 0.5), 
        plot.caption = element_text(size = 8))
```


***

```{r}
a <- obwody %>%
  filter(data== max(data)) %>%
  filter(skumulowane == "zgony") %>%
  group_by(Obwód, Kod, data)%>%
  summarise(
    liczba = sum(liczba),
    data2 = max(data)+1
  )
b <- a%>%
  arrange(desc(liczba))
c <- obwody %>%
  filter(skumulowane=="zgony")%>%
  group_by(data)%>%
  summarise(
    zgony = sum(liczba)
  )

d <- obwody %>%
  group_by(data) %>%
  summarise(
    liczba = sum(liczba)
  )%>%
  left_join(c, by="data")%>%
  mutate(smiertelnosc = round(zgony/liczba*100, 1))%>%
  filter(data==max(data))
```

Przypadki śmiertelne zanotowano do tej pory w `r sum(a$liczba>0)` obwodach, najwięcej w `r if_else(b[1,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", b[1,1], "m"))` (`r b[1,4]`) oraz `r if_else(b[2,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", b[2,1], "m"))` (`r b[2,4]`) i `r if_else(b[3,1]=="Kijów", paste("w Kijowie"), paste0("w obwodzie ", b[3,1], "m"))` (`r b[3,4]`). Śmiertelność zachorowań na Covid-19 wynosi `r d[1,4]`%.

```{r}
ggplot() + 
  geom_map(data=a, aes(map_id=Kod, fill=liczba), map=shp1f) + 
  geom_path(data = shp1f, aes(x=long, y=lat, group=group), colour="grey", size=0.001) + 
  coord_map(projection = "mercator") + 
  scale_fill_gradient(low = "white", high = "red") +
  labs(fill= "liczba \nzgonów", title = "Liczba zgonów z powodu Covid-19",
       subtitle =  paste0( "stan na ", format(as.Date(a$data2), "%d/%m/%Y"), ", godz. 9.00"),
       caption = "Źródło - Ministerstwo Zdrowia Ukrainy") +
  geom_label(data=szpitale.lozka, aes(x=long, y=lat), label=a$liczba, size=3) +
  theme_bw()+
  theme(axis.ticks = element_blank(), panel.border = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_blank(), legend.position = c(0.1, 0.2),
        panel.grid.minor = element_blank(),panel.grid.major = element_blank(), plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5), plot.background = element_rect(colour = "grey", size = 0.5), 
        plot.caption = element_text(size = 8))

```



```{r include=F}
# może dodam w późniejszych wersjach

colors <- c("podejrzewani"="orange", "chorzy"="red", "wolne łóżka"="blue")
ggplot(data=szpitale.oblozenie)+
  geom_bar(aes(x=reorder(Obwód, -liczba), y=liczba, fill=stan), stat="identity")+
  labs(x="obwód", y="liczba łóżek", fill="",
       title = "Sytuacja w szpitalach na Ukrainie",
       subtitle = "wg stanu na 30 marca",
       caption = "Źródło: Departament Polityki Regionalnej i Decentralizacji Biura Prezydenta Ukrainy.")+
  scale_fill_manual(values = colors)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1), plot.title = element_text(hjust = 0.5), 
        plot.subtitle = element_text(hjust = 0.5) , legend.direction = "horizontal", legend.position=c(0.76,0.9), 
        plot.caption = element_text(hjust = 0, size = 8), plot.background = element_rect(colour = "grey", size = 0.5))

```

***

### Ukraina na tle państw sąsiednich



```{r include=FALSE, message= FALSE}
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggspatial)
```


```{r}

wybrane <- c("Poland", "Ukraine", "Slovakia", "Hungary", "Moldova", "Romania", "Belarus", "Russia")
ISO <- c("POL", "UKR", "SVK", "BLR", "HUN", "RUS", "MDA", "ROU")
sasiedzi <- ne_countries(scale = "medium", returnclass = "sf", continent = "Europe", country = wybrane) %>%
  rename(ISO3 = 10)

```

```{r}
load(file = "E:/R/COVID-19/covid.ECDC.Rda")
ECDC <- covid.ECDC %>%
  filter(ISO3 %in% ISO)

load(file = "E:/R/COVID-19/Ukraina.dane/obwody_dzienne.Rda")
UA1 <- obwody %>%
  filter(data==max(ECDC$data))%>%
  filter(skumulowane=="zgony")%>%
  group_by(data)%>%
  summarise(
    zgony = sum(liczba),
    lat=49.5,
    long = 31.5
  )

UA2 <- obwody %>%
  filter(data==max(ECDC$data))%>%
  group_by(data)%>%
  summarise(
    zarazeni = sum(liczba),
    lat=49.5,
    long = 31.5
  )

```

```{r}
b <-filter(ECDC, data==max(data))
#dodajmy long lat Rosji
b[6,6:7] <- c(54,37)
#dodajemy long lat Ukrainy
b[8,6:7] <- c(UA2$lat, UA2$long)
# dodajemy dane z Ukrainy
b[8,14:15] <- c(UA2$zarazeni, UA1$zgony)
```


```{r fig.width=7, fig.height=7}
ggplot(data = sasiedzi) +
  geom_sf(aes(fill=b$suma.chorych)) +
  coord_sf(xlim = c(13, 43), ylim = c(43, 58), expand = F) +
  scale_fill_gradient(low = "white", high = "orange")+
  geom_label(data=b, aes(x=Long, y=Lat), label=b$suma.chorych, size=3) +
  labs(fill="liczba \nprzypadków", x="", y="",
       title = "Liczba potwierdzonych przypadków Covid-19",
       subtitle = paste( "stan na", format(as.Date(UA1$data), "%d/%m/%Y")),
       caption = "Źródło: Ministerstwo Zdrowia Ukrainy, European Centre for Disease Prevention and Control") +
  theme_bw()+
  theme(axis.ticks = element_blank(), panel.border = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_blank(),panel.grid.minor = element_blank(),panel.grid.major = element_blank(), 
        legend.direction = "horizontal", legend.position=c(0.15,0.9), plot.caption = element_text(hjust = 0, size = 8),
        plot.background = element_rect(colour = "grey", size = 0.5), plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
```

***


```{r}
# dane o zachorowaniu na 100 tys. mieszkańców
c <- b%>%
  mutate(zach.100 = suma.chorych*100000/population)%>%
  mutate(zach.100 = round(zach.100, 1))
```

```{r fig.width=7, fig.height=7}
ggplot(data = sasiedzi) +
  geom_sf(aes(fill=c$zach.100)) +
  coord_sf(xlim = c(13, 43), ylim = c(43, 58), expand = F) +
  scale_fill_gradient(low = "#FFFFCC", high = "#FF3300")+
  geom_label(data=b, aes(x=Long, y=Lat), label=c$zach.100, size=3) +
  labs(fill="liczba \nprzypadków", x="", y="",
       title = "Liczba zarażeń na 100 tys. mieszkańców",
       subtitle = paste( "stan na", format(as.Date(UA1$data), "%d/%m/%Y")),
       caption = "Źródło: Ministerstwo Zdrowia Ukrainy, European Centre for Disease Prevention and Control, Bank Światowy") +
  theme_bw()+
  theme(axis.ticks = element_blank(), panel.border = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_blank(),panel.grid.minor = element_blank(),panel.grid.major = element_blank(), 
        legend.direction = "horizontal", legend.position=c(0.15,0.9), plot.caption = element_text(hjust = 0, size = 8),
         plot.background = element_rect(colour = "grey", size = 0.5), plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
```

***


```{r fig.width=7, fig.height=7}
ggplot(data = sasiedzi) +
  geom_sf(aes(fill=b$suma.zgonow)) +
  coord_sf(xlim = c(13, 43), ylim = c(43, 58), expand = F) +
  scale_fill_gradient(low = "white", high = "red")+
  geom_label(data=b, aes(x=Long, y=Lat), label=b$suma.zgonow, size=3) +
  labs(fill="liczba \nzgonów", x="", y="",
       title = "Liczba zgonów z powodu Covid-19",
       subtitle = paste( "stan na", format(as.Date(UA1$data), "%d/%m/%Y")),
       caption = "Źródło: Ministerstwo Zdrowia Ukrainy, European Centre for Disease Prevention and Control") +
  theme_bw()+
  theme(axis.ticks = element_blank(), panel.border = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_blank(),panel.grid.minor = element_blank(),panel.grid.major = element_blank(), 
        legend.direction = "horizontal", legend.position=c(0.15,0.9), plot.caption = element_text(hjust = 0, size = 8),
         plot.background = element_rect(colour = "grey", size = 0.5), plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
```

***

```{r}
przyrost <- ECDC %>%
  filter(suma.chorych>100)%>%
  group_by(Państwo) %>%
  mutate(id=row_number()-1)
library(scales)
```

```{r fig.width=7, fig.height=5, warning=T, message=T}
a <- filter(przyrost, id<sum(przyrost$Państwo=="Ukraina"))
kolory <- c("Polska"="red", "Ukraina"="deepskyblue", "Mołdawia"= "gold", "Rosja"="green", "Węgry"="magenta", "Rumunia"="darkgrey", "Słowacja"="brown", "Białoruś"="orange")

ggplot(data=a, aes(x=id, y=proc.wzrostu.chorych, color=Państwo)) + 
  geom_point(size=4) +
  geom_smooth(se=F, size = 2)+
  scale_color_manual(values = kolory)+
  scale_y_continuous(labels = percent_format(accuracy = 5L))+
  labs(color="", x="liczba dni od przekroczenia poziomu 100 zarażonych", y="dzienny wzrost zachorowań",
       title="Dzienny przyrost nowych przypadków Covid-19",
       subtitle = paste( "stan na", format(as.Date(UA1$data), "%d/%m/%Y")),
       caption = "Żródło: European Centre for Disease Prevention and Control")+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5), plot.caption = element_text(hjust = 0, size = 8),
        plot.background = element_rect(colour = "grey", size = 0.5))
```

```{r fig.width=7, fig.height=5, warning=T, message=T}
#zależność miedzy przyrostem i ilością zachorowań
kontynenty <- c("Europa", "Azja", "Ameryka Pn")
a <- covid %>%
  filter(proc.zach>0, liczba.zachorowan>500, liczba.zachorowan<100000)%>%
  filter(Kontynenty!="NA")%>%
  filter(Kontynenty %in% kontynenty)%>%
  filter(data!="2020-01-22")

ggplot(data=a)+
  geom_point(aes(x=liczba.zachorowan, y=proc.zach), alpha=0.5)+
  geom_smooth(aes(x=liczba.zachorowan, y=proc.zach, color=Kontynenty), se=F)+
  scale_y_continuous(limits = c(0,0.4), labels = label_percent())+
  #scale_x_continuous(limits = c(100,50000))+
  facet_wrap(~Kontynenty, scale="free")+
  theme_bw() 
  #theme(panel.spacing.x = unit(4, "mm"))
# wykorzystania  - spacing osi x
# scale_x_continuous(breaks = seq(0, 4.8, 0.5), minor_breaks = seq(0, 4.8, 0.1))
```

